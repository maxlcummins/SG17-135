# Run on Jupiter13 on 15-6-2020
# Command 1 - Run abricate
nohup snakemake -j --use-conda  -p > /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/logs/abricate/nohup_abricatelord.out &
# Command 2 - Run snplord with SG17-135 as reference.
# Note that SG17-135 is not included as an input file (and only as an input)
# Note that the following strains were excluded as a previous run of analysis found them to be highly divergent from our strains, obscuring branching.
# "SAL_BB1353AA_AS", "SAL_IB2995AA_AS","SAL_BB9821AA_AS","SAL_CB0612AA_AS"
nohup snakemake -s Snakefile_assemblies-j --use-conda -p -j > /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/logs/snplord/nohup_snplord.out &
# Copied the tree, snp table and abricate files to their new destination
cp /home/malcummi/Data/Manuscripts/Salmonella_AMR/Agona_assemblies/analysis/snp/Agona_200/fasttree/SG17-135.clean.fullcore.tree /home/malcummi/Data/Manuscripts/Salmonella_AMR/Agona_assemblies/analysis/snp/Agona_200/snp_dists/SG17-135.pairwise_snps.csv /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/analysis/snp_outputs/
cat /home/malcummi/Data/Manuscripts/Salmonella_AMR/Agona_assemblies/analysisabricateAgona_200/*/* > /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/analysis/abricate.txt
# Command 3 - Ran abricate with new Salmonella PIA database
nohup snakemake -j --use-conda  -p > /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/logs/abricate/nohup_abricatelord_PIAs.out &

# Command 4 - ran snplord with Agona80
nohup snakemake -s Snakefile_assemblies-j  -j --use-conda -p > /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/logs/snplord/nohup_Agona80.out &

# Command 5 - ran snplord with Agona195 (SAL_LB7623AA_AS was trash [stuck out on tree and highest number of low quality bases and second lowest N50)
nohup snakemake -s Snakefile_assemblies-j  -j --use-conda -p > /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/logs/snplord/nohup_Agona80.out &

# Command 6 - cp
cd /home/malcummi/Data/Manuscripts/Salmonella_AMR/Agona_assemblies/analysis/snp
for f in *; do mkdir /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/analysis/snp_outputs/${f}; done
for f in *; do cp ${f}/fasttree/* /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/analysis/snp_outputs/${f}/${f}_SG17-135.clean.fullcore.tree; done
for f in *; do cp ${f}/snp_dists/* /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/analysis/snp_outputs/${f}/${f}_SG17-135.pairwise_snps.csv; done

#Abricate was rerun on a new PAI database which correctly contains SPI-2
nohup snakemake -j --use-conda  -p > /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/logs/abricate/nohup_abricatelord_PIAs.out &

#Copy PAI abricate data to github repo
cat /home/malcummi/Data/Manuscripts/Salmonella_AMR/Agona_assemblies/analysis/abricateAgona_200/Salmonella_PIAs/* > /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/analysis/abricate/abricate_PAIs.txt

#Run pointfinder
source activate ~/miniconda3_old/envs/pointfinder
cd /home/malcummi/Data/Manuscripts/Salmonella_AMR/Agona_assemblies/Agona_200
for f in *.fasta; do mkdir /home/malcummi/Data/pointfinder/test/${f/\.fasta/}; /home/malcummi/Data/pointfinder/PointFinder.py -i $f -o /home/malcummi/Data/pointfinder/test/${f/\.fasta/} -p /home/malcummi/Data/pointfinder/pointfinder_db -s salmonella -m blastn -m_p /usr/local/ncbi-blast-ihpc-2.8.1+/bin/blastn; done
cd /home/malcummi/Data/pointfinder/test
for f in */*.tsv; do awk 'NR == 1 {print $0 "\tname_file"; next;}{print $0 "\t" FILENAME;}' $f; done > /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/analysis/pointfinder/pointfinder_results_tmp.txt
cd /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/analysis/pointfinder/
awk 'FNR==1 { header = $0; print } $0 != header' pointfinder_results_tmp.txt > pointfinder_results.txt
rm pointfinder_results_tmp.txt

#PAI data inconsitent with SPIfinder. Instead, CT18 was submitted to SPI finder and a database of the sequences detected within it was downloaded and made into a abricate DB.
#Abricate snakemake was rerun:
nohup snakemake -j --use-conda  -p > /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/logs/abricate/nohup_abricatelord_PIA_CT18.out &
cat /home/malcummi/Data/Manuscripts/Salmonella_AMR/Agona_assemblies/analysis/abricateAgona_200/SPIs_1-10_12_CT18/* > /home/malcummi/Data/Manuscripts/Salmonella_AMR/SG17-135/analysis/abricate/abricate_PAIs_CT18.txt

#Collect other non SPI islands from the PAI database
grep "C6" abricate_PAIs.txt >> abricate_PAIs_CT18.txt
grep "CS54" abricate_PAIs.txt >> abricate_PAIs_CT18.txt

